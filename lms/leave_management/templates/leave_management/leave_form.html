{% extends 'leave_management/index.html' %}
{% load static %}
{% block content%}


<div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 text-dark">Leave Form</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active"><a href="{% url 'dashboard' %}">Dashboard</a></li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->

    <!-- /.content-header -->


<form class="needs-validation"   id="leaveForm" method="post" action=" " autocomplete="off" enctype="multipart/form-data" >
    {% csrf_token %}
  <div class="form-row">
    <div class="col-md-3 mb-3">
      <label for="validationCustom01">Employee name</label>
      <input type="text" class="form-control" name="employee_name" id="employee_name" placeholder="Employee Name" value="{{request.user.first_name}} {{request.user.last_name}}" required readonly>

    </div>
      <div class="col-md-3 mb-3">
      <label for="date">Application Date</label>
      <input   class="form-control" id="current_Date" name="current_date" readonly>
      </div>


    </div>

  <div class="form-row">
    <div class="col-md-3 mb-3">
      <label for="leave_type">Leave Type :</label>
      <select id="leave_type" name="leave_type" class="form-control" onchange="LeaveType(this.value)" required>
      <option value="" disabled hidden selected>--Select Leave Type--</option>
          {% for leave_types in leave_type %}
      <option value="{{leave_types.id}}">{{leave_types.leave_name}}</option>
      {% endfor %}
      </select>
    </div>
    <div class="col-md-3 mb-3">
      <label for="remaining_leave">Remaining Leave</label>
      <input type="text" class="form-control" name="remaining_leave" id="remaining_leave" placeholder="Remaining Leave" value="0" readonly>
     </div>
  </div>

   <div class="form-row">
     <div class="col-md-3 mb-3">
      <label for="date">From Date</label>
      <input type="text"  class="form-control datepickstart" id="from_date" name="from_date"  onchange ="daysDifference()" placeholder="mm-dd-yyyy" required  >
     </div>

    <div class="col-md-3 mb-3">
      <label for="date">Till Date</label>
      <input type="text" onload="getDate()" class="form-control" id="till_date" name="till_date" onchange ="daysDifference()" placeholder="mm-dd-yyyy" required  >
    </div>
   </div>
   Total leave applied for days : <h style="color:32A80F" id="result" class="total_taken_leave" name="total_taken_leave"></h>
    <div>
        <input type="hidden" name="total_taken_leave" id="total_taken_leave" >
	</div>

    <br>
   <div class="col-md-6 mb-3">
       <label for="full_day">Full Day :</label>
       <input type="radio"  name="day" id="full_day" value="1">
       <label for="half_day">Half Day :</label>
       <input type="radio"  name="day" id="half_day"  onclick="myFunction();">
   </div>


   <div class="form-row">
     <div class="col-md-6 mb-3">
   <label for="remark">Remark</label>
   <textarea class="form-control" name="remark" id="remark" placeholder="remark" required></textarea>
     </div>
   </div>
   <div class="form-row">
     <div class="col-md-6 mb-3">
       <label for="myfile">Attachment</label>
       <input type="file"  name="myfile" id="file" class="form-control"    accept=".jpg, .jpeg, .pdf" >
         <span id="error-message" class="validation-error-label"></span>
   </div>
   </div>
   <div>
       <input type="hidden" name="status" value="pending" id="status">
   </div>

      <button class="btn btn-primary" type="submit">Apply</button>
     <a href="" class="btn btn-primary" onclick="window.location.reload">Reset</a>
</form>
</div>


<!--<script src="https://code.jquery.com/jquery-2.0.2.min.js" integrity="sha256-TZWGoHXwgqBP1AF4SZxHIBKzUdtMGk0hCQegiR99itk=" crossorigin="anonymous"></script>-->
<script>
/*
var date = new Date();
     date.setDate(date.getDate()-14);
    $('.datepickstart').datepicker({
     autoclose: true,
     todayHighlight: true,
     format: 'dd/mm/yyyy',
      startDate: date
    });
*/

</script>

<!--This date is start from 14 days before,from today's date.-->
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>


<!--This is the script for from_date where previous day is disable from current day to 14 previous day. -->
<script>
$(function() {

  var holidays =  {{holiday_list|safe}} ;

  function noSundaysOrHolidays(from_date) {
    var day = from_date.getDay();
    if (day != 0) {
      var d = from_date.getDate();
      var m = from_date.getMonth();
      var y = from_date.getFullYear();
      for (i = 0; i < holidays.length; i++) {
        if($.inArray((d) + '-' + (m+1) + '-' + y, holidays) != -1) {
          return [false];
        }
      }
      return [true];
    } else {
      return [day != 0, ''];
    }
  }

  $('#from_date').datepicker({
    onClose: function(dateText, inst) {
        $(this).attr("disabled", false);
    },
    beforeShow: function(input, inst) {
      $(this).attr("disabled", true);
    },
    beforeShowDay: noSundaysOrHolidays,
    minDate: -14,
    dateFormat: 'dd-mm-yy',
  });

});
</script>

<!--This is the script for till_date where previous day is disable from current day to 14 previous day. -->
<script>
$(function() {

  var holidays = {{holiday_list|safe}};

  function noSundaysOrHolidays(till_date) {
    var day = till_date.getDay();
    if (day != 0) {
      var d = till_date.getDate();
      var m = till_date.getMonth();
      var y = till_date.getFullYear();
      for (i = 0; i < holidays.length; i++) {
        if($.inArray((d) + '-' + (m+1) + '-' + y, holidays) != -1) {
          return [false];
        }
      }
      return [true];
    } else {
      return [day != 0, ''];
    }
  }

  $('#till_date').datepicker({
    onClose: function(dateText, inst) {
        $(this).attr("disabled", false);
    },
    beforeShow: function(input, inst) {
      $(this).attr("disabled", true);
    },
    beforeShowDay: noSundaysOrHolidays,
    minDate: -14,
    dateFormat: 'dd-mm-yy',
  });
 
});
</script>




<script>
/*
$(function() {
   $( "#from_date" ).datepicker({minDate: -14});
  });

$(function() {
    $( "#till_date" ).datepicker({minDate: -14});
  });

*/
</script>


<!--This date is start from today's date.(from-date)-->
<script>
/*
  var today = new Date().toISOString().split('T')[0];
    document.getElementsByName("from_date")[0].setAttribute('min', today);
*/
</script>

<!--This date is start from today's date.(till_date)-->
<script>
/*
   var today = new Date().toISOString().split('T')[0];
    document.getElementsByName("till_date")[0].setAttribute('min', today);
*/
</script>


<!--This is a normal datepicker-->
<script>
/*  function getDate(){
    var today = new Date();

document.getElementById("till_date").value = today.getFullYear() + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + ('0' + today.getDate()).slice(-2);

} */
</script>



<!--For current date -->
<script>
var date = new Date();
var day = date.getDate();
var month = date.getMonth() + 1;
var year = date.getFullYear();

if (month < 10) month = "0" + month;
if (day < 10) day = "0" + day;

var today = year + "-" + month + "-" + day

document.getElementById('current_Date').value = today;

</script>


<!--Day difference between two datapikcer -->
<script>
function daysDifference() {
         //define two variables and fetch the input from HTML form
         var date1 = document.getElementById("from_date").value ;
         var dateI1 = date1.split("-").reverse().join("-");

         var date2 = document.getElementById("till_date").value;
         var dateI2 = date2.split("-").reverse().join("-");

         if (date2 != ''){

         $.ajax({
                type : "POST",
                url: "{% url 'leave_management:ajax_posting' %}",
                data: {
                 date1 :dateI1,
                 date2 : dateI2,
                 csrfmiddlewaretoken: '{{ csrf_token }}',
                 dataType: "json",

                },

                success: function(data){
                   document.getElementById("result").innerHTML = data.count ;
                    document.getElementById("total_taken_leave").value = data.count ;
                },

                failure: function() {

                }

            });

         }

         }


/*
function daysDifference() {
         //define two variables and fetch the input from HTML form
         var dateI1 = document.getElementById("date").value;
         var dateI2 = document.getElementById("till_date").value;


         if (dateI2 != ''){

         //define two date object variables to store the date values
         var date1 = new Date(dateI1);
         var date2 = new Date(dateI2);

         //calculate time difference
         var time_difference = date2.getTime() - date1.getTime();

         //calculate days difference by dividing total milliseconds in a day
         var result = (time_difference / (1000 * 60 * 60 * 24))+1;

         document.getElementById("result").innerHTML = result ;
         document.getElementById("total_taken_leave").value = result ;
         }

         }*/



</script>



<!--Script for onchange leave type in form so that reamaining leave is display-->
<script>
function LeaveType(leaveval) {


{% for key, value in leave_dict.items %}
if (leaveval == {{key}}) {
  document.getElementById("remaining_leave").value = {{value}};
}
{% endfor%}
};
</script>

<!--Script for validation of file extension and size when file uploaded.-->
<script>

//attaching "change" event to the file upload button
document.getElementById("file").addEventListener("change", validateFile)

function validateFile(){
  const allowedExtensions =  ['jpg','jpeg', 'pdf'],
        sizeLimit = 2097152; // 2 megabyte

  const { name:fileName, size:fileSize } = this.files[0];
  const fileExtension = fileName.split(".").pop();
  alert(fileExtension)

  if(!allowedExtensions.includes(fileExtension)){
    alert("file type not allowed, Please select pdf, jpeg, jpg file"  );
    this.value = null;
  }else if(fileSize > sizeLimit){
    alert("File too Big, please select a file less than 2mb"  )
    this.value = null;
  }
}
</script>

<!--Script for size validation on attach file-->
<script>
/*
var uploadField = document.getElementById("file");

uploadField.onchange = function() {
    if(this.files[0].size > 2097152){
       alert("File is too big!");
       this.value = "";
    };
};
*/
</script>

<!--Script for Half day leave-->

<script>
    function myFunction() {
          var day = document.getElementById("total_taken_leave").value ;
          var half_day_minus = parseFloat(day)-parseFloat(0.5);


          document.getElementById("result").innerHTML = half_day_minus ;
          document.getElementById("total_taken_leave").value = half_day_minus ;

    }
</script>



{% endblock %}